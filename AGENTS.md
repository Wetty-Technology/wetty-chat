## Project Overview

wetty-chat is a chat application targeting ~20k users / ~10k messages per day. It has a **Rust backend** (Axum + Diesel/PostgreSQL) and a **React frontend** (Framework7 + Vite).

## Commands
### Backend (Rust)
```bash
cd backend
cargo run          # Run server on http://localhost:3000
cargo build        # Build
cargo test         # Run tests
cargo clippy       # Lint
diesel migration run   # Apply migrations
diesel migration revert  # Revert last migration
```

### Frontend (Node/Vite)
```bash
cd wetty-chat-mobile
npm install
npm run dev        # Dev server with hot reload, proxies /api → localhost:3000
npm run build      # Production build to ./www
```

## Architecture

### Backend (`/backend`)

- **Entry point:** `src/main.rs` — sets up Axum router, middleware (request IDs, tracing, CORS), and `AppState`
- **AppState:** R2D2 connection pool (`PgConnection`) + Snowflake ID generator (`utils/ids.rs`)
- **Handlers:** `src/handlers/` — `chats.rs`, `messages.rs`, `members.rs`
- **Auth:** `src/utils/auth.rs` — `CurrentUid` extractor reads `X-User-Id` header (i32)
- **Schema:** `src/schema.rs` — auto-generated by Diesel from migrations

**Routes:**
```
GET  /chats                    → list user's chats (cursor-paginated)
POST /chats                    → create group
GET  /chats/{id}/messages      → list messages (cursor-paginated, before cursor)
POST /chats/{id}/messages      → send message
GET  /chats/{id}/members       → list members
```

**Pagination:** Cursor-based (`limit` + `after` query params). Max limits: 100 chats, 100 messages.

**IDs:** Snowflake IDs (i64) for groups, messages, attachments. i32 for users.

**Migrations:** `backend/migrations/` — single initial migration creates all tables.

### Frontend (`/wetty-chat-mobile`)

- **Build:** Vite 7, root at `./src`, output to `./www`
- **Dev proxy:** `/api/*` → `http://localhost:3000` (configured in `vite.config.js`)
- **API client:** `src/api/client.js` — Axios with `X-User-Id` header interceptor (hardcoded to `1` currently — placeholder for real auth)
- **Routing:** Framework7 routes in `src/js/routes.js`
- **Pages:** `src/pages/chats.jsx` (chat list), `src/pages/chat-thread.jsx` (messages)
- **Path alias:** `@` → `./src`

### Database Schema

Key tables: `users`, `groups`, `group_membership`, `messages`, `attachments`

`messages` supports threading via `reply_to_id` + `reply_root_id`. Soft deletes via `deleted_at`. Indexed on `(gid, created_at)` for efficient pagination.

## Environment

**Backend `.env`:**
```
DATABASE_URL=postgres://postgres:testPassword1!@127.0.0.1:5432/wetty_chat
```

**Frontend `.env` (production only):**
```
VITE_API_BASE_URL=   # Empty = use Vite proxy in dev
```

## Key Design Decisions

- HTTP REST for CRUD; WebSockets planned (not yet implemented) for real-time push
- Snowflake IDs enable future multi-server scaling
- Client-generated IDs (`client_generated_id`) on messages for deduplication
- Auth is currently a placeholder — `X-User-Id` header accepted without verification
- Strict Rust lints: `forbid(unsafe_code)`, `deny(unused_must_use)`
